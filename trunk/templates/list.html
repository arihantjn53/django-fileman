<html>
<head>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<title>File Manager</title>
<link rel='stylesheet' href='/fm/media/style.css' type='text/css'>
<script type="text/javascript" src="/media/jquery.js"></script>
</head>

<body>
<script>
var ufile = 1;
var currentE = null;
var temp_string = null;
function preview(path){
    $(".preview > .content > p").html("<img src='/fm/preview/"+path+"'>");
    $('.block > .content').hide();
    $(".preview > .content").show();
    $(".info > .content").show();
}

function fileClick(name){
    path = "{{ pwd }}/"+name;
    $.get("/fm/geturl/"+path, {}, onSuccessUrl);
    t = name.substr(-4, 4)
    if(t == ".jpg"){
        preview(path);
    } else if(t == ".gif"){
        preview(path);
    } else if(t == ".png"){
        preview(path);
    }
}

function onSuccessUrl(obj){
    $("#url").val(obj);
}
$(document).ready(function(){
    $("#filelist > tbody > tr:nth-child(odd)").addClass("odd");
    $("#filelist > tbody > tr > td > .dir").each(function(){
        $(this).dblclick(function(){
            window.location="http://127.0.0.1:8000/fm/list/{{ pwd }}/"+$(this).text();
        });
    $('.block > h2').each(function(){ $(this).click(function(){
        $('.block > .content').hide();
        $(this).parent().children(".content").toggle();
    }); });
});

    $("#filelist > tbody > tr > td > .file").each(function(){
        $(this).attr("onclick", 'fileClick($(this).text())');
    });
});

function addFileFild(){
    ufile = ufile+1;
    $("#addFileFild").before('<p><input type="file" name="ufile'+ufile+'" size="16"></p>');
}

function del(){
    $("#fileListForm").attr("action", "/fm/del/?next={{ pwd }}");
    $("#fileListForm").submit();
}

function dest(){
    $("#fileListForm").attr("action", "/fm/dest/?next={{ pwd }}");
    $("#fileListForm").submit();
}

function createDir(){
    name = prompt("Создать дирикторию:", "");
    if(name != null){
        window.location="http://127.0.0.1:8000/fm/createdir/{{ pwd }}/"+name;
    }
}

function copy_one(element, filename, filepath){
    currentE = $(element).parent();
    temp_string = filepath;
    $(element).parent().html("<img src='/fm/media/ajax-loader.gif'>");
    $.post("/fm/addbuffer/?xhr", {'path': filepath, 'action': "copy"}, successCopy);
    $('.buffer > h2').click();
    return 0;
}

function successCopy(data){
    if(data=="success"){
        currentE.html('<img src="/fm/media/page_white_copy.png" alt="Копировать">');
        $(".buffer > h2").after('<p><img src="/fm/media/page_white_copy.png">'+nameFromPath(temp_string)+' <a href="/fm/remove/'+temp_string+'"><img src="/fm/media/cross.png"></a></p>');
    }
    else {
        alert("Произошла ошибка.\nСервер сообщает:\n"+data);
    }
}

function cut_one(element, filename, filepath){
    currentE = $(element).parent();
    temp_string = filepath;
    $(element).parent().html("<img src='/fm/media/ajax-loader.gif'>");
    $.post("/fm/addbuffer/?xhr", {'path': filepath, 'action': "cut"}, successCut);
    $('.buffer > h2').click();
    return 0;
}

function successCut(data){
    if(data=="success"){
        currentE.html('<img src="/fm/media/cut.png" alt="Вырезать">');
        $(".buffer > h2").after('<p><img src="/fm/media/cut.png">'+nameFromPath(temp_string)+' <a href="/fm/remove/'+temp_string+'"><img src="/fm/media/cross.png"></a></p>');
    }
    else {
        alert("Произошла ошибка.\nСервер сообщает:\n"+data);
    }
}

function rename(file){
    prompt("Переименовать", file);
}

function del_one(element, filename, filepath){
    currentE = $(element).parent();
    if(confirm("Вы уверены, что хотите удалить "+filename+"?")){
        $(element).parent().html("<img src='/fm/media/ajax-loader.gif'>");
        $.post("/fm/del/?xhr", {filename: filepath}, successDelete);
    }
    return 0;
}

function successDelete(data){
    if(data=="success"){
        currentE.parent().fadeOut("slow", function(){ 
        currentE.parent().remove();
        $("#filelist > tbody > tr:nth-child(odd)").addClass("odd");
        });
    }
    else {
        alert("При удалении произошла ошибка.\nСервер сообщает:\n"+data);
    }
}

function dest_one(element, filename, filepath){
    currentE = $(element).parent();
    if(confirm("Внимание! Операция не обратима!\nВы уверены, что хотите уничтожить "+filename+"?")){
        $(element).parent().html("<img src='/fm/media/ajax-loader.gif'>");
        $.post("/fm/dest/?xhr", {filename: filepath}, successDelete);
    }
    return 0;
}

function nameFromPath(path){
    name = path.split("/");
    name = name[$(name).size()-1];
    return name;
}
</script>

<div id="sidebar">
<div class="block actions">
<h2>Действия</h2>
    <div class="content">
    <p><img src="/fm/media/user.gif"> {{ user }} <a href="#">[ Выйти ]</a></p><br>
    <p><a href="/fm/list/"><img src="/fm/media/house.png"> Домашняя папка</a></p>
    {% if perms.fileman.can_fm_add %}<p><a href="javascript:createDir();"><img src="/fm/media/folder_add.png"> Создать дирикторию</a></p>{% endif %}
    {% if perms.fileman.can_fm_add %}<p><a href="/fm/past/{{ pwd }}"><img src="/fm/media/page_white_paste.png"> Вставить</a></p>{% endif %}
    {% if perms.fileman.can_fm_del %}<p><a href="/fm/basket/"><img src="/fm/media/bin.png"> Корзина</a></p>{% endif %}
    <br>
    {% if perms.fileman.can_fm_del %}<p><a href="javascript:del();"><img src="/fm/media/delete.png"> Удалить</a></p>{% endif %}
    {% if perms.fileman.can_fm_destruct %}<p><a href="javascript:dest();"><img src="/fm/media/cross.png"> Уничтожить</a></p>{% endif %}
    </div>
</div>
<div class="block buffer">
<h2>Буфер</h2>
    <div class="content">
    {% if  buffer %}
    {% for file, action, name in buffer %}
        <p>{% ifequal action 1 %}<img src="/fm/media/page_white_copy.png">{% endifequal %}
        {% ifequal action 2 %}<img src="/fm/media/cut.png">{% endifequal %}
        {{ name }}
        <a href="/fm/remove/{{ file }}"><img src="/fm/media/cross.png"></a>
        </p>
    {% endfor %}
    {% else %}
    Буфер пуст.
    {% endif %}
    </div>
</div>
<div class="block info">
<h2>Информация</h2>
    <div class="content">
    <p>Ссылка: <input id="url" type="input"></p>
    <p><a href="#">в буфер обмена</a></p>
    </div>
</div>
{% if perms.fileman.can_fm_add %}
<div class="block upload">
<h2>Загрузить</h2>
    <div class="content">
    <form id="uploadForm" action="/fm/upload/" method="post" enctype="multipart/form-data">
    <p><input type="file" name="ufile1" size="16"></p>
    <p id="addFileFild"><a href="javascript:addFileFild()">ещё</a></p>
    <p><input type="hidden" name="path" value="{{ pwd }}">
    <input type="submit" value="Загрузить!"></p>
    </form>
    </div>
</div>
{% endif %}
<div class="block preview">
<h2>Предпросмотр</h2>
    <div class="content">
    <p>
    Нет картинки
    </p>
    </div>
</div>
</div>
<div id="main">
{% if perms.fileman.can_fm_list %}
<div id="pwd"><b>Вы сейчас здесь:</b> {{ pwd }}</div>
<form id="fileListForm" method="post">
<table id="filelist" cellpadding="0" cellspacing="0">
{% ifnotequal pwd user.fileman_Setting.root %}
<tr>
<td><input DISABLED type="checkbox" id="d">
<img src="/fm/media/bullet_go.png"> <label for="d" class="dir">..</label></td>
<td>&nbsp;</td>
{% if perms.fileman.can_fm_add %}
<td>&nbsp;</td>
{% endif %}
{% if perms.fileman.can_fm_rename %}
<td>&nbsp;</td>
{% endif %}
{% if perms.fileman.can_fm_rename %}
<td>&nbsp;</td>
{% endif %}
{% if perms.fileman.can_fm_del %}
<td>&nbsp;</td>
{% endif %}
{% if perms.fileman.can_fm_destruct %}
<td>&nbsp;</td>
{% endif %}
</tr>
{% endifnotequal %}
{% for file in dirlist %}
<tr><td>
<input type="checkbox" name="{{ file.name }}" value="{{ file.path }}" id="d{{ forloop.counter }}">
<img src="/fm/media/folder.gif"> <label for="d{{ forloop.counter }}" class="dir">{{ file.name }}</label></td>
<td>{{ file.size }}</td>
{% if perms.fileman.can_fm_add %}
<td width="18px">
    <a href="#" title="Копировать"><img src="/fm/media/page_white_copy.png" alt="Копировать"></a>
</td>
{% endif %}
{% if perms.fileman.can_fm_rename %}
<td width="18px">
    <a href="#" title="Вырезать"><img src="/fm/media/cut.png" alt="Вырезать"></a>
</td>
{% endif %}
{% if perms.fileman.can_fm_rename %}
<td width="18px">
    <a href="#" title="Переименовать"><img src="/fm/media/pencil.png" alt="Переименовать"></a>
</td>
{% endif %}
{% if perms.fileman.can_fm_del %}
<td width="18px">
    <a href="#" onclick="return del_one(this, '{{ file.name }}', '{{ file.path }}');" title="Удалить"><img src="/fm/media/delete.png" alt="Удалить"></a>
</td>
{% endif %}
{% if perms.fileman.can_fm_destruct %}
<td width="18px">
    <a href="#" onclick="return dest_one(this, '{{ file.name }}', '{{ file.path }}');" title="Уничтожить"><img src="/fm/media/cross.png" alt="Уничтожить"></a>
</td>
{% endif %}
</tr>
{% endfor %}
{% for file in filelist %}
<tr><td>
<input type="checkbox" name="{{ file.name }}" value="{{ file.path }}" id="f{{ forloop.counter }}">
<img src="/fm/media/file.gif"> <label for="f{{ forloop.counter }}" class="file">{{ file.name }}</label></td>
<td width="100px">
    {{ file.size|filesizeformat }}
</td>
{% if perms.fileman.can_fm_add %}
<td width="18px">
    <a href="#" onclick="return copy_one(this, '{{ file.name }}', '{{ file.path }}');" title="Копировать"><img src="/fm/media/page_white_copy.png" alt="Копировать"></a>
</td>
{% endif %}
{% if perms.fileman.can_fm_rename %}
<td width="18px">
    <a href="#" onclick="return cut_one(this, '{{ file.name }}', '{{ file.path }}');" title="Вырезать"><img src="/fm/media/cut.png" alt="Вырезать"></a>
</td>
{% endif %}
{% if perms.fileman.can_fm_rename %}
<td width="18px">
    <a href="javascript:rename('{{ file.name }}');" title="Переименовать"><img src="/fm/media/pencil.png" alt="Переименовать"></a>
</td>
{% endif %}
{% if perms.fileman.can_fm_del %}
<td width="18px">
    <a href="#" onclick="return del_one(this, '{{ file.name }}', '{{ file.path }}');" title="Удалить"><img src="/fm/media/delete.png" alt="Удалить"></a>
</td>
{% endif %}
{% if perms.fileman.can_fm_destruct %}
<td width="18px">
    <a href="#" onclick="return dest_one(this, '{{ file.name }}', '{{ file.path }}');" title="Уничтожить"><img src="/fm/media/cross.png" alt="Уничтожить"></a>
</td>
{% endif %}
</tr>
{% endfor %}
</form>
</table>

{% endif %}
</div>

